import tkinter as tk
from tkinter import ttk, messagebox
import threading
import time
import os
import subprocess
import sys
import urllib.request
import zipfile

# Sysinternals psshutdown 下载地址（微软官方）
PSDOWNLOAD_URL = "https://download.sysinternals.com/files/PSTools.zip"
PSFILENAME = "psshutdown.exe"

class ShutdownTimerApp:
    def __init__(self, root):
        self.root = root
        self.root.title("定时关机工具")
        self.root.geometry("400x300")
        self.root.resizable(False, False)

        self.selected_action = tk.StringVar(value="shutdown")
        self.hours = tk.IntVar(value=0)
        self.minutes = tk.IntVar(value=0)
        self.seconds = tk.IntVar(value=0)
        self.remaining_time = 0
        self.stop_event = threading.Event()

        self.ensure_psshutdown()

        # ===== GUI 元素 =====
        action_frame = ttk.LabelFrame(root, text="选择动作", padding=10)
        action_frame.pack(padx=10, pady=10, fill="x")

        actions = [("关机", "shutdown"),
                   ("重启", "restart"),
                   ("睡眠", "sleep"),
                   ("休眠", "hibernate")]

        for text, value in actions:
            ttk.Radiobutton(action_frame, text=text, variable=self.selected_action, value=value).pack(side="left", padx=5)

        time_frame = ttk.LabelFrame(root, text="设置时间", padding=10)
        time_frame.pack(padx=10, pady=10, fill="x")

        ttk.Label(time_frame, text="小时:").pack(side="left")
        ttk.Entry(time_frame, textvariable=self.hours, width=5).pack(side="left", padx=5)

        ttk.Label(time_frame, text="分钟:").pack(side="left")
        ttk.Entry(time_frame, textvariable=self.minutes, width=5).pack(side="left", padx=5)

        ttk.Label(time_frame, text="秒:").pack(side="left")
        ttk.Entry(time_frame, textvariable=self.seconds, width=5).pack(side="left", padx=5)

        self.label_time = ttk.Label(root, text="剩余时间: 00:00:00", font=("Arial", 14))
        self.label_time.pack(pady=20)

        btn_frame = ttk.Frame(root)
        btn_frame.pack(pady=10)
        ttk.Button(btn_frame, text="启动", command=self.start_timer).pack(side="left", padx=10)
        ttk.Button(btn_frame, text="取消", command=self.cancel_timer).pack(side="left", padx=10)

    # 自动下载并解压 psshutdown.exe
    def ensure_psshutdown(self):
        base_dir = os.path.dirname(os.path.abspath(__file__))
        psshutdown_path = os.path.join(base_dir, PSFILENAME)
        if os.path.exists(psshutdown_path):
            return
        try:
            tmp_zip = os.path.join(base_dir, "pstools.zip")
            messagebox.showinfo("提示", "检测到缺少 psshutdown.exe，程序将自动下载。")
            urllib.request.urlretrieve(PSDOWNLOAD_URL, tmp_zip)
            with zipfile.ZipFile(tmp_zip, 'r') as zip_ref:
                zip_ref.extract(PSFILENAME, base_dir)
            os.remove(tmp_zip)
            messagebox.showinfo("提示", "psshutdown.exe 下载完成。")
        except Exception as e:
            messagebox.showerror("下载失败", f"无法下载 psshutdown.exe:\n{e}")

    def start_timer(self):
        total_seconds = self.hours.get() * 3600 + self.minutes.get() * 60 + self.seconds.get()
        if total_seconds <= 0:
            messagebox.showerror("错误", "请输入一个大于 0 的时间！")
            return

        self.remaining_time = total_seconds
        self.stop_event.clear()
        threading.Thread(target=self.countdown).start()

    def countdown(self):
        while self.remaining_time > 0 and not self.stop_event.is_set():
            mins, secs = divmod(self.remaining_time, 60)
            hrs, mins = divmod(mins, 60)
            self.label_time.config(text=f"剩余时间: {hrs:02}:{mins:02}:{secs:02}")
            time.sleep(1)
            self.remaining_time -= 1

        if not self.stop_event.is_set():
            self.execute_action(self.selected_action.get())

    def execute_action(self, action):
        base_dir = os.path.dirname(os.path.abspath(__file__))
        psshutdown_path = os.path.join(base_dir, PSFILENAME)

        if action == "sleep":
            if os.path.exists(psshutdown_path):
                subprocess.Popen(f'"{psshutdown_path}" -d -t 0', shell=True)
            else:
                messagebox.showerror("错误", "未找到 psshutdown.exe！")
        elif action == "hibernate":
            subprocess.Popen("shutdown /h", shell=True)
        elif action == "shutdown":
            subprocess.Popen("shutdown /s /f /t 0", shell=True)
        elif action == "restart":
            subprocess.Popen("shutdown /r /f /t 0", shell=True)

        os._exit(0)

    def cancel_timer(self):
        self.stop_event.set()
        self.remaining_time = 0
        self.label_time.config(text="剩余时间: 00:00:00")


if __name__ == "__main__":
    root = tk.Tk()
    app = ShutdownTimerApp(root)
    root.mainloop()
